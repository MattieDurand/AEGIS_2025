<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Online Doctor - Medical Assistant</title>
  <link rel="stylesheet" href="styles.css?v=1.1">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div id="app">
    <header id="header">
      <h1>AI Online Doctor</h1>
      <p>Your intelligent medical assistant</p>
    </header>

    <!-- ==================== STEP 1: Body Part Selection ==================== -->
    <section id="body-selection" class="active">
      <h2>Select the body part where you have symptoms</h2>
      <div class="body-map">
        <button class="body-part" data-part="head">Head</button>
        <button class="body-part" data-part="chest">Chest</button>
        <button class="body-part" data-part="abdomen">Abdomen</button>
        <button class="body-part" data-part="arm">Arm</button>
        <button class="body-part" data-part="leg">Leg</button>
        <button class="body-part" data-part="back">Back</button>
      </div>
    </section>

    <!-- ==================== STEP 2: Symptom Selection ==================== -->
    <section id="symptoms-section" style="display: none;">
      <h2>Select your symptoms</h2>
      <div class="symptom-tags" id="symptom-tags"></div>

      <!-- Pain severity slider -->
      <div class="pain-severity">
        <label for="painRange">Pain Severity (0–10):</label>
        <input type="range" min="0" max="10" value="5" class="slider" id="painRange">
        <span id="painValue">5</span>
      </div>

      <!-- Photo upload -->
      <div class="photo-upload">
        <h3>Upload a photo (optional)</h3>
        <input type="file" id="photoInput" accept="image/*" multiple>
        <div id="photoPreview" class="photo-preview-grid"></div>
      </div>

      <button id="to-comorbidities" class="next-btn">Next: Comorbidities</button>
    </section>

    <!-- ==================== STEP 3: Comorbidities ==================== -->
    <section id="comorbidities-section" style="display: none;">
      <h2>Comorbidities</h2>
      <p>Please list any other conditions you have:</p>
      <div id="comorbidities-list">
        <div class="comorbidity-item">
          <div>
            <label for="comorbidity-name-0">Name</label>
            <input type="text" id="comorbidity-name-0" name="comorbidities[0][name]">
          </div>
          <div>
            <label for="comorbidity-years-0">Diagnosed (years ago)</label>
            <input type="number" id="comorbidity-years-0" name="comorbidities[0][diagnosed_years_ago]">
          </div>
          <div>
            <label for="comorbidity-prognosis-0">Prognosis</label>
            <select id="comorbidity-prognosis-0" name="comorbidities[0][prognosis]">
              <option value="Stable">Stable</option>
              <option value="Improving">Improving</option>
              <option value="Worsening">Worsening</option>
            </select>
          </div>
        </div>
      </div>
      <button type="button" id="add-comorbidity-btn">➕ Add Another Comorbidity</button>
      <button id="start-diagnosis" class="next-btn">Start Diagnosis</button>
    </section>

    <!-- ==================== STEP 4: Results ==================== -->
    <section id="results-section" style="display: none;">
      <h2>Diagnosis Results</h2>
      <div id="results-content"></div>
      <button id="restart-btn">Restart</button>
    </section>

    <!-- ==================== API Connection Status ==================== -->
    <div id="connection-status-box" class="status-box">
      <p>Groq API connection: <span id="connection-status">Checking...</span></p>
      <button id="test-connection-btn">Test Connection</button>
      <button id="debug-connection-btn">Debug</button>
    </div>
  </div>

  <!-- ==================== Scripts ==================== -->
  <script>
    let groqConnected = false;
    let comorbidityIndex = 1;

    // ------------------- Connection Testing -------------------
    async function testGroqProxy() {
      const statusEl = document.getElementById("connection-status");
      statusEl.textContent = "Testing...";
      try {
        const response = await fetch("/.netlify/functions/groqProxy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: [{ role: "user", content: "ping" }] })
        });
        if (!response.ok) throw new Error("HTTP " + response.status);
        const data = await response.json();
        groqConnected = true;
        statusEl.textContent = "Connected";
        statusEl.style.color = "green";
        console.log("Groq proxy success:", data);
      } catch (err) {
        groqConnected = false;
        statusEl.textContent = "Failed";
        statusEl.style.color = "red";
        console.error("Groq proxy failed:", err);
      }
    }

    async function debugGroqProxy() {
      const statusEl = document.getElementById("connection-status");
      statusEl.textContent = "Debugging...";
      try {
        const response = await fetch("/.netlify/functions/groqProxy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: [{ role: "user", content: "debug test" }] })
        });
        const text = await response.text();
        console.log("Debug raw response:", text);
        statusEl.textContent = "Debug complete (check console)";
      } catch (err) {
        console.error("Debug error:", err);
        statusEl.textContent = "Debug failed";
      }
    }

    document.getElementById("test-connection-btn").addEventListener("click", testGroqProxy);
    document.getElementById("debug-connection-btn").addEventListener("click", debugGroqProxy);

    // ------------------- Navigation -------------------
    function setupBodySelection() {
      document.querySelectorAll(".body-part").forEach(btn => {
        btn.addEventListener("click", () => {
          document.getElementById("body-selection").style.display = "none";
          document.getElementById("symptoms-section").style.display = "block";
        });
      });
    }

    document.getElementById("to-comorbidities").addEventListener("click", () => {
      document.getElementById("symptoms-section").style.display = "none";
      document.getElementById("comorbidities-section").style.display = "block";
    });

    document.getElementById("start-diagnosis").addEventListener("click", startDiagnosis);
    document.getElementById("restart-btn").addEventListener("click", () => {
      document.getElementById("results-section").style.display = "none";
      document.getElementById("body-selection").style.display = "block";
    });

    // ------------------- Comorbidities -------------------
    document.getElementById("add-comorbidity-btn").addEventListener("click", addComorbidity);

    function addComorbidity() {
      const list = document.getElementById("comorbidities-list");
      const newItem = document.createElement("div");
      newItem.className = "comorbidity-item";
      newItem.innerHTML = `
        <div>
          <label for="comorbidity-name-${comorbidityIndex}">Name</label>
          <input type="text" id="comorbidity-name-${comorbidityIndex}" name="comorbidities[${comorbidityIndex}][name]">
        </div>
        <div>
          <label for="comorbidity-years-${comorbidityIndex}">Diagnosed (years ago)</label>
          <input type="number" id="comorbidity-years-${comorbidityIndex}" name="comorbidities[${comorbidityIndex}][diagnosed_years_ago]">
        </div>
        <div>
          <label for="comorbidity-prognosis-${comorbidityIndex}">Prognosis</label>
          <select id="comorbidity-prognosis-${comorbidityIndex}" name="comorbidities[${comorbidityIndex}][prognosis]">
            <option value="Stable">Stable</option>
            <option value="Improving">Improving</option>
            <option value="Worsening">Worsening</option>
          </select>
        </div>
        <button type="button" class="remove-btn" onclick="removeComorbidity(this)" style="margin-left: 10px;">❌</button>
      `;
      list.appendChild(newItem);
      comorbidityIndex++;
    }

    function removeComorbidity(btn) {
      btn.parentElement.remove();
    }

    // ------------------- Diagnosis -------------------
    async function startDiagnosis() {
      if (!groqConnected) {
        alert("Groq connection not established. Please check your connection first.");
        return;
      }
      document.getElementById("comorbidities-section").style.display = "none";
      document.getElementById("results-section").style.display = "block";
      const results = document.getElementById("results-content");
      results.innerHTML = "<p>Analyzing symptoms...</p>";

      try {
        const response = await fetch("/.netlify/functions/groqProxy", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ messages: [{ role: "user", content: "diagnose" }] })
        });
        const data = await response.json();
        results.innerHTML = "<p><strong>AI Diagnosis:</strong> " + (data.choices?.[0]?.message?.content || "No result") + "</p>";
      } catch (err) {
        results.innerHTML = "<p>Error retrieving diagnosis.</p>";
        console.error("Diagnosis error:", err);
      }
    }

    // ------------------- Pain Slider -------------------
    document.getElementById("painRange").addEventListener("input", function () {
      document.getElementById("painValue").textContent = this.value;
    });

    // ------------------- Photo Upload -------------------
    document.getElementById("photoInput").addEventListener("change", function (event) {
      const preview = document.getElementById("photoPreview");
      preview.innerHTML = "";
      Array.from(event.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const img = document.createElement("img");
          img.src = e.target.result;
          img.className = "preview-img";
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    // ------------------- Init -------------------
    document.addEventListener("DOMContentLoaded", () => {
      setupBodySelection();
      testGroqProxy();
    });
  </script>
</body>
</html>

